name: Publish

on:
    release:
        types: [published]

concurrency:
    group: "publish"
    cancel-in-progress: false

jobs:
    gate:
        runs-on: ubuntu-latest
        if: contains(github.event.release.tag_name, 'docs') == false
        steps:
            - name: Gate check
              run: echo "Publish condition met"

    test:
        needs: gate
        uses: ./.github/workflows/test.yml

    build-pkg:
        needs: gate
        uses: ./.github/workflows/build-pkg.yml

    validate-tag:
        needs: gate
        uses: ./.github/workflows/validate-tag.yml

    publish-pkg:
        needs: [test, build-pkg, validate-tag]
        if: contains(github.event.release.tag_name, 'docs') == false
        environment:
            name: npm-publish
            url: https://www.npmjs.com/package/typectx
        runs-on: ubuntu-latest
        permissions:
            contents: read # Required for checkout
            id-token: write # Required for OIDC with npm
        steps:
            - name: Checkout
              uses: actions/checkout@v5

            - name: Setup Node.js
              uses: actions/setup-node@v5
              with:
                  node-version: "lts/*"
                  registry-url: "https://registry.npmjs.org"
                  package-manager-cache: false

            - name: Update npm
              run: npm install -g npm@latest

            - name: Download build artifacts
              uses: actions/download-artifact@v5
              with:
                  name: typectx-build
                  path: ./artifacts

            - name: Set version from release tag
              run: |
                  VERSION=${GITHUB_REF#refs/tags/}
                  VERSION=${VERSION#v}
                  echo "Setting version to: $VERSION"
                  echo "VERSION=$VERSION" >> $GITHUB_ENV

            - name: Set version for typectx
              working-directory: ./artifacts/typectx
              run: |
                  npm version $VERSION --no-git-tag-version
                  echo "typectx package.json version is now: $(cat package.json | jq -r .version)"

            - name: Set version for @typectx/react
              working-directory: ./artifacts/@typectx/react/main
              run: |
                  npm version $VERSION --no-git-tag-version
                  echo "@typectx/react package.json version is now: $(cat package.json | jq -r .version)"

            - name: Dry publish typectx
              if: contains(github.event.release.tag_name, 'dry')
              working-directory: ./artifacts/typectx
              run: |
                  npm publish --tag dry --dry-run

            - name: Dry publish @typectx/react
              if: contains(github.event.release.tag_name, 'dry')
              working-directory: ./artifacts/@typectx/react/main
              run: |
                  npm publish --tag dry --dry-run

            - name: Publish typectx to Canary
              if: contains(github.event.release.tag_name, 'canary')
              working-directory: ./artifacts/typectx
              run: |
                  npm publish --tag canary

            - name: Publish @typectx/react to Canary
              if: contains(github.event.release.tag_name, 'canary')
              working-directory: ./artifacts/@typectx/react/main
              run: |
                  npm publish --tag canary

            - name: Publish typectx to Alpha
              if: contains(github.event.release.tag_name, 'alpha')
              working-directory: ./artifacts/typectx
              run: |
                  npm publish --tag alpha

            - name: Publish @typectx/react to Alpha
              if: contains(github.event.release.tag_name, 'alpha')
              working-directory: ./artifacts/@typectx/react/main
              run: |
                  npm publish --tag alpha

            - name: Publish typectx to Beta
              if: contains(github.event.release.tag_name, 'beta')
              working-directory: ./artifacts/typectx
              run: |
                  npm publish --tag beta

            - name: Publish @typectx/react to Beta
              if: contains(github.event.release.tag_name, 'beta')
              working-directory: ./artifacts/@typectx/react/main
              run: |
                  npm publish --tag beta

            - name: Publish typectx to RC
              if: contains(github.event.release.tag_name, 'rc')
              working-directory: ./artifacts/typectx
              run: |
                  npm publish --tag rc

            - name: Publish @typectx/react to RC
              if: contains(github.event.release.tag_name, 'rc')
              working-directory: ./artifacts/@typectx/react/main
              run: |
                  npm publish --tag rc

            - name: Publish typectx to Latest
              if: contains(github.event.release.tag_name, '-') == false
              working-directory: ./artifacts/typectx
              run: |
                  npm publish --tag latest

            - name: Publish @typectx/react to Latest
              if: contains(github.event.release.tag_name, '-') == false
              working-directory: ./artifacts/@typectx/react/main
              run: |
                  npm publish --tag latest
